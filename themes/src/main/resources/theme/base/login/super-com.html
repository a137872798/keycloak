<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>数据安全检查评估系统</title>
        <link rel="stylesheet" href="/resources/jxuks/login/keycloak/css/element-ui.css" />
        <script src="/resources/jxuks/login/keycloak/js/vue.min.js"></script>
        <script src="/resources/jxuks/login/keycloak/js/index.js"></script>
        <script src="/resources/jxuks/login/keycloak/js/axios.min.js"></script>
        <script src="/resources/jxuks/login/keycloak/js/jsencrypt.min.js"></script>

        <!-- <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
        <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
        <script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <script src="./axios.min.js"></script>
        <script src="./jsencrypt.min.js"></script> -->
        <style>
            html,
            body,
            #app {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }

            .login-container {
                height: 100%;
                min-height: 550px;
                /* background-image: url('/resources/jxuks/login/keycloak/img/keycloak-super-com-bg.gif'); */
                /* background-image: url('./assets/keycloak-leftbg.png'); */
                background-image: url('/resources/jxuks/login/keycloak/img/keycloak-leftbg.png');
                background-size: 100% 100%;
                background-size: cover;
            }

            .login-box {
                position: relative;
                box-sizing: border-box;
                display: flex;
                justify-content: space-between;
                width: 100%;
                height: 100%;
            }

            .dark {
                position: absolute;
                top: 13px;
                right: 18px;
            }

            .login-left {
                /* width: 800px; */
                /* margin-right: 10px; */
                /* padding-top: 300px; */
                /* padding-left: 275px; */
                flex: 1;
                position: relative;
            }
            /* .login-left-img {
                width: 576px;
                height: 593px;
                position: absolute;
                top: 14%;
                left: 50%;
                margin-left: -288px;
            }
            .login-left-text {
                width: 680px;
                position: absolute;
                bottom: 4%;
                left: 50%;
                margin-left: -340px;
            } */
            .login-left-text {
                width: 29vw;
                position: absolute;
                bottom: 4%;
                left: 50%;
                margin-left: -20%;
            }
            .login-left-img {
                width: 26.3vw;
                height: 58vh;
                position: absolute;
                left: 50%;
                margin-left: -20%;
                transform: translateY(36%);
            }

            .login-form {
                width: 420px;
                background-color: #fff;
            }

            .login-icon {
                width: 48px;
                height: 48px;
            }

            .el-form-item {
                margin-bottom: 40px;
            }

            .login-btn {
                display: flex;
                justify-content: space-between;
                width: 100%;
                margin-top: 40px;
                white-space: nowrap;
            }

            .el-button {
                width: 185px;
            }

            @media screen and (width <= 1250px) {
                .login-left {
                    display: none;
                }
            }

            @media screen and (width <= 600px) {
                .login-form {
                    width: 97% !important;
                }
            }
            .form-group input {
                width: 100%;
                height: 30px;
                border-radius: 4px;
                /* border: 1px solid #fff; */
                border: none;
                text-indent: 8px;
                background-color: #fff;
                background-image: none;
                border-radius: 4px;
                box-sizing: border-box;
                color: #606266;
                display: inline-block;
                height: 40px;
                line-height: 40px;
                outline: 0;
                padding: 0 0;
            }

            .form-group .pf-m-primary {
                text-indent: 0;
                cursor: pointer;
                background: #085aff;
                border-radius: 4px;
                color: #fff;
                height: 40px;
                font-size: 16px;
                font-family: PingFangSC-Medium, PingFang SC;
                font-weight: 500;
                color: #ffffff;
                text-align: center;
            }

            .usernameError,
            .passwordError,
            .formError {
                margin-bottom: 26px;
                color: #f56c6c;
                font-size: 12px;
                line-height: 1;
                padding-top: 4px;
                top: 100%;
                left: 0;
            }

            .formError {
                margin-bottom: 26px;
            }

            .left-text {
                font-size: 48px;
                font-family: PingFangSC-Semibold, PingFang SC;
                font-weight: 600;
                color: #ffffff;
            }

            .left-subtext {
                font-size: 24px;
                font-family: Helvetica;
                color: #ffffff;
            }

            .left-subtext1 {
                font-size: 24px;
                font-family: PingFangSC-Regular, PingFang SC;
                font-weight: 400;
                color: #b0e1ff;
                margin-top: 35px;
                width: 482px;
            }

            .left-subtext2 {
                font-size: 24px;
                font-family: PingFangSC-Medium, PingFang SC;
                font-weight: 500;
                color: #ffffff;
                text-decoration: underline;
                cursor: pointer;
            }

            .left-subtext2:hover {
                opacity: 0.8;
            }

            .logo-text {
                font-size: 32px;
                font-family: AlimamaShuHeiTi-Bold, AlimamaShuHeiTi;
                font-weight: bold;
                color: #0068a9;
                margin: 0;
            }

            .logo-subtext {
                font-size: 20px;
                font-family: SourceHanSansCN-Medium, SourceHanSansCN;
                font-weight: 500;
                color: #98a1ab;
                margin: 0;
                line-height: 10px;
                margin-bottom: 20px;
            }

            .login-logo {
                width: 100%;
                /* height: 26%; */
                /* height: 23.5%; */
                background: url('/resources/jxuks/login/keycloak/img/keycloak-top-bg.png');
                /* background: url('./assets/keycloak-top-bg.png'); */
                background-size: cover;
                position: relative;
                height: calc(25vw / 2);
                /* background-size: 100% 100%; */
                /* box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.1); */
            }

            @media screen and (max-width: 600px) {
                .my-element {
                    height: 50px;
                }
            }

            .login-form-right {
                width: 520px;
                background-color: #fff;
            }

            .login-inner {
                display: flex;
                flex-wrap: wrap;
                width: 100%;
                /* height: calc(100% - 251px); */
                justify-content: space-around;
                flex-direction: column;
                position: relative;
                height: 74%;
            }

            #kc-form-login {
                width: calc(100% - 120px);
                height: 330px;
                top: 60px;
                position: absolute;
                transform: translateX(-50%);
                margin-left: 50%;
            }

            .bottom-div {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                bottom: 30px;
                font-size: 12px;
                font-family: PingFangSC-Regular, PingFang SC;
                font-weight: 400;
                color: #999999;
                flex-wrap: wrap;
            }

            .bottom-div div {
                width: 100%;
                text-align: center;
            }

            .bottom-div img {
                width: 132px;
            }

            .input-icon {
                width: 14px;
                height: 14px;
                padding-left: 12px;
            }

            .form-input-out {
                display: flex;
                align-items: center;
                border-radius: 4px;
                border: 1px solid #cecece;
                margin-bottom: 24px;
            }

            .code-out-div {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .code-out-div .form-input-out {
                margin-bottom: 0;
            }

            .code-out-div .code-div {
                width: 40%;
                display: flex;
                justify-content: flex-end;
            }
            .login-sbm-outter {
                width: calc(100% - 24px);
                padding: 0 12px;
            }
            .login-sbm {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .login-hint {
                background: #fff1f0;
                border-radius: 4px;
                border: 1px solid #ffccc7;
                font-size: 14px;
                font-weight: 400;
                color: rgba(0, 0, 0, 0.88);
                width: 82%;
                height: 42px;
                line-height: 42px;
                text-align: center;
                margin: 40px auto;
            }
            .formText {
                font-size: 14px;
                font-family: PingFangSC-Regular, PingFang SC;
                font-weight: 400;
                color: rgba(0, 0, 0, 0.88);
            }
            .formContent {
                display: flex;
                flex: 1;
                justify-content: flex-end;
            }
            .formContent-input {
                width: 56%;
                height: 36px;
                border-radius: 4px;
                border: 1px solid #cecece;
                padding-left: 12px;
                padding-right: 12px;
                margin-right: 6px;
            }
            .formContent-btn {
                width: 76px;
                background: #0068a9;
                border-radius: 4px;
                border: none;
                color: #fff;
                cursor: pointer;
            }
            .fileExport {
                width: 30%;
                height: 40px;
                background: #0068a9;
                border-radius: 4px;
                color: #fff;
                border: none;
            }
            .cxsc {
                color: #3a8ee6;
                margin-left: 12px;
            }
            .subbtn {
                width: 87%;
                height: 40px;
                background: #0068a9;
                border-radius: 4px;
                color: #fff;
                border: none;
            }
            .login-form-right {
                /* width: 520px; */
                width: 25vw;
                background-color: #fff;
                position: relative;
            }
            .bottomText {
                text-align: center;
                position: absolute;
                bottom: 2%;

                left: 1%;
                left: 50%;
                margin-left: -16%;
                font-size: 12px;
                font-family: PingFangSC-Regular, PingFang SC;
                font-weight: 400;
                color: #999999;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <div class="login-container flx-center">
                <div class="login-box">
                    <div class="login-left">
                        <img
                            src="/resources/jxuks/login/keycloak/img/keycloak-bgTop.png"
                            class="login-left-img"
                            alt=""
                        />
                        <img
                            class="login-left-text"
                            src="/resources/jxuks/login/keycloak/img/keycloak-text.png"
                            alt=""
                        />
                    </div>
                    <div class="login-form-right">
                        <div class="login-logo"></div>
                        <div class="login-inner" v-if="type">
                            <!-- onsubmit="login.disabled = true; return true;" -->
                            <form
                                id="kc-form-login"
                                :action="reqUrl + '&session_code=' + formSessionCode"
                                method="post"
                            >
                                <div class="form-group form-input-out">
                                    <img
                                        class="input-icon"
                                        src="/resources/jxuks/login/keycloak/img/keycloak-login-account.png"
                                    />

                                    <el-input
                                        v-model="usernameInput"
                                        placeholder="请输入用户名"
                                        tabindex="1"
                                        id="username"
                                        class="pf-c-form-control"
                                        name="username"
                                        value=""
                                        type="text"
                                        autofocus
                                        autocomplete="off"
                                        aria-invalid=""
                                    />
                                </div>

                                <div class="form-group form-input-out">
                                    <img
                                        class="input-icon"
                                        src="/resources/jxuks/login/keycloak/img/keycloak-login-password.png"
                                    />

                                    <el-input
                                        v-model="passwordInput"
                                        show-password
                                        placeholder="请输入密码"
                                        tabindex="2"
                                        id="password"
                                        class="pf-c-form-control"
                                        name="password"
                                        type="password"
                                        autocomplete="off"
                                        aria-invalid=""
                                    />
                                </div>
                                <div class="code-out-div">
                                    <div class="form-group form-input-out" style="width: 60%">
                                        <img
                                            class="input-icon"
                                            src="/resources/jxuks/login/keycloak/img/keycloak-login-code.png"
                                        />

                                        <div>
                                            <el-input
                                                v-model="codeInput"
                                                style="width: 100%"
                                                placeholder="请输入验证码"
                                                tabindex="3"
                                                id="captcha"
                                                class="pf-c-form-control"
                                                name="captcha"
                                                type="text"
                                                autocomplete="off"
                                                aria-invalid=""
                                            />
                                        </div>
                                    </div>
                                    <div class="code-div">
                                        <img
                                            class="code-img"
                                            :src="codeImg"
                                            @click="changeCodeImg(1)"
                                        />
                                    </div>
                                </div>

                                <div class="formError"></div>

                                <div class="form-group login-pf-settings">
                                    <div id="kc-form-options"></div>
                                    <div class=""></div>
                                </div>

                                <div id="kc-form-buttons" class="form-group" @click="handleLogin">
                                    <input type="hidden" id="id-hidden-input" name="credentialId" />
                                    <input
                                        tabindex="4"
                                        class="pf-c-button pf-m-primary pf-m-block btn-lg"
                                        name="login"
                                        id="kc-login"
                                        value="登 录"
                                        readonly
                                    />
                                </div>
                            </form>
                            <div class="bottom-div">
                                <div>Copyright © 2023</div>
                                <div>杭州超级科技有限公司</div>
                                <!-- <div>版权所有</div> -->
                            </div>
                        </div>
                        <div v-if="!type">
                            <div class="login-hint">您的设备未进行授权，请上传授权文件后使用</div>
                            <div class="login-sbm-outter">
                                <div class="login-sbm">
                                    <span class="formText">设备码：</span>
                                    <div class="formContent">
                                        <input
                                            tabindex="3"
                                            id="sbm"
                                            class="pf-c-form-control formContent-input"
                                            type="text"
                                            autocomplete="off"
                                            aria-invalid=""
                                            v-model="sbm"
                                        />
                                        <button class="formContent-btn" @click="copy">复制</button>
                                    </div>
                                </div>

                                <div class="login-sbm" style="margin-top: 40px">
                                    <span class="formText">验证码：</span>
                                    <div class="formContent">
                                        <input
                                            tabindex="3"
                                            id="yzm"
                                            class="pf-c-form-control formContent-input"
                                            type="text"
                                            autocomplete="off"
                                            aria-invalid=""
                                            v-model="yzm"
                                        />
                                        <button class="formContent-btn" @click="copyYzm">
                                            复制
                                        </button>
                                    </div>
                                </div>

                                <div class="login-sbm" style="margin-top: 40px">
                                    <span class="formText">授权文件上传：</span>
                                    <div style="width: 100%; flex: 1">
                                        <button class="fileExport" @click="upload" v-if="!fileName">
                                            点击上传
                                        </button>
                                        <div v-else>
                                            <span>{{fileName}}</span>
                                            <span class="cxsc" @click="upload">重新上传</span>
                                        </div>
                                        <input
                                            type="file"
                                            ref="clearFile"
                                            @change="getFile($event)"
                                            style="display: none"
                                        />
                                    </div>
                                </div>

                                <div class="login-sbm" style="margin-top: 40px">
                                    <button class="subbtn" @click="submit">提交授权</button>
                                </div>
                            </div>
                            <div class="bottomText">
                                <div>Copyright © 2023</div>
                                <div>杭州超级科技有限公司版权所有</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        new Vue({
            el: '#app',
            data: {
                codeImg: '',
                reqUrl: '',
                captchaUrl: '',
                sessionCode: '',
                formSessionCode: '',
                type: true,
                sbm: '',
                yzm: '',
                fileName: '',
                file: '',
                passwordInput: '',
                usernameInput: '',
                codeInput: '',
            },
            methods: {
                handleLogin() {
                    console.log('333333');
                    if (!this.usernameInput) {
                        ELEMENT.Message.warning('请输入用户名');
                        return;
                    }
                    if (!this.passwordInput) {
                        ELEMENT.Message.warning('请输入密码');
                        return;
                    }
                    if (!this.codeInput) {
                        ELEMENT.Message.warning('请输入验证码');
                        return;
                    }
                    localStorage.setItem('username', this.usernameInput);
                    localStorage.setItem('password', this.passwordInput);

                    const encryptor = new JSEncrypt(); // 创建加密对象实例
                    const pubKey =
                        'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCHnRTKkf5AtVqOCHkW/Ihn0D+h/YGi8KTXdP/DZxKcGYYMZaAU3z8Z2DbZg+tWlIkS9FomPEi1QNxpVyKiMb10Amw4dDq6lzk1yK9MNviShqO+T9ITnwnpYLSHdwohYf+58biEqnIz6E1vUIoH+XV5zLNWfeiHq7yt5dLSEJdiowIDAQAB';
                    encryptor.setPublicKey(pubKey); //设置公钥
                    document.getElementById('password').value = encryptor.encrypt(
                        document.getElementById('password').value
                    );
                    document.getElementById('kc-form-login').submit();
                },
                changeCodeImg(val) {
                    if (val === 1) {
                        this.sessionCode = this.getCookie('session_code');
                    }
                    this.codeImg = `${this.captchaUrl}&session_code=${this.sessionCode}`;
                    setTimeout(() => {
                        this.formSessionCode = this.getCookie('session_code');
                    }, 1000);
                },
                getCookie(name) {
                    let strcookie = document.cookie;
                    let arrcookie = strcookie.split('; ');
                    //遍历匹配
                    for (let i = 0; i < arrcookie.length; i++) {
                        let arr = arrcookie[i].split('=');
                        if (arr[0] == name) {
                            return arr[1];
                        }
                    }
                    return '';
                },

                check() {
                    const axiosInstance = axios.create({
                        baseURL: `${window.location.origin}/checkApi`,
                        timeout: 5000,
                        withCredentials: false,
                    });
                    axiosInstance.get('/license/check').then((response) => {
                        if (response.data.code == 300) {
                            this.type = false;

                            let { data } = response.data;
                            this.sbm = data.macheCode;
                            this.yzm = data.checkCode;
                        } else {
                            this.type = true;
                        }
                    });
                },
                copy() {
                    const input = document.querySelector('#sbm');
                    input.select();
                    if (document.execCommand('copy')) {
                        document.execCommand('copy');
                    }
                    ELEMENT.Message.success('复制成功');
                },
                copyYzm() {
                    const input = document.querySelector('#yzm');
                    input.select();
                    if (document.execCommand('copy')) {
                        document.execCommand('copy');
                    }
                    ELEMENT.Message.success('复制成功');
                },
                submit() {
                    const axiosInstance = axios.create({
                        baseURL: `${window.location.origin}/checkApi`,
                        timeout: 5000,
                        withCredentials: false,
                    });
                    let formData = new FormData();
                    formData.append('licfile', this.file);
                    axiosInstance.post('/license/upload', formData).then((res) => {
                        if (res.data.code == 200) {
                            this.type = true;
                            // this.changeCodeImg();
                            window.location.reload();
                        } else {
                            alert(res.data.message);
                        }
                    });
                },
                getFile(e) {
                    let file = event.target.files;
                    this.fileName = file[0].name;
                    this.file = file[0];
                },
                upload() {
                    this.$refs.clearFile.click();
                },
            },
            mounted() {
                let dom = document.querySelector('.formError');
                if (dom && dom.innerText) {
                    this.usernameInput = localStorage.getItem('username') || '';
                    this.passwordInput = localStorage.getItem('password') || '';
                } else {
                    localStorage.removeItem('username');
                    localStorage.removeItem('password');
                }
                this.check();
                this.changeCodeImg();
                let _this = this;
                document.onkeydown = function (event) {
                    var e = event || window.event || arguments.callee.caller.arguments[0];
                    if (e && e.keyCode == 13) {
                        _this.handleLogin();
                    }
                };
            },
        });
    </script>
</html>
